name: Terraform Destroy (No Backend - Force Cleanup)

on:
  workflow_dispatch:

jobs:
  destroy:
    name: Destroy AWS Infra (Local Init)
    runs-on: self-hosted
    permissions:
      id-token: write
      contents: read

    defaults:
      run:
        working-directory: Infra

    env:
      AWS_REGION: eu-central-1
      TF_IN_AUTOMATION: true
      TF_VAR_db_master_password: ${{ secrets.TF_VAR_db_master_password }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::760981412376:role/github-actions-terraform-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      # ðŸ”¹ Init zonder S3 backend
      - name: Terraform Init (local)
        run: terraform init -input=false -backend=false

      # ðŸ”¹ Forceer ECS deletions (zodat cluster niet vastloopt)
      - name: Force remove ECS services
        run: |
          for cluster in $(aws ecs list-clusters --query "clusterArns[]" --output text); do
            for service in $(aws ecs list-services --cluster $cluster --query "serviceArns[]" --output text); do
              aws ecs update-service --cluster $cluster --service $service --desired-count 0 || true
              aws ecs delete-service --cluster $cluster --service $service --force || true
            done
          done

      # ðŸ”¹ Terraform destroy zonder lock of remote backend
      - name: Terraform Destroy (force)
        run: terraform destroy -auto-approve -lock=false -var "db_master_password=ChangeMe_StrongPW!"

      # ðŸ”¹ Volledige cleanup van overgebleven AWS-resources
      - name: Force Cleanup (ECR, Lambda, S3, DynamoDB)
        run: |
          echo "Force cleanup in progress..."
          for repo in $(aws ecr describe-repositories --query "repositories[].repositoryName" --output text); do
            aws ecr delete-repository --repository-name $repo --force || true
          done
          for fn in $(aws lambda list-functions --query "Functions[].FunctionName" --output text); do
            aws lambda delete-function --function-name $fn || true
          done
          for bucket in $(aws s3api list-buckets --query "Buckets[].Name" --output text); do
            if [[ "$bucket" == *"case2nca"* ]]; then
              aws s3 rb s3://$bucket --force || true
            fi
          done
          for table in $(aws dynamodb list-tables --query "TableNames[]" --output text); do
            aws dynamodb delete-table --table-name $table || true
          done

      - name: âœ… Done
        run: echo "âœ… AWS resources fully destroyed, local cleanup complete!"
